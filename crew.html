<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: Inter, sans-serif; 
            padding: 0; 
            margin: 0; 
            background: transparent;
            font-size: 14px;
            color: #2c3345;
        }
        .field { margin-bottom: 12px; }
        label { 
            font-weight: 500; 
            display: block; 
            margin-bottom: 6px;
            color: #2c3345;
            font-size: 14px;
        }
        #status { 
            color: #8a94a6; 
            font-size: 12px; 
            margin-bottom: 8px;
        }
        .error { color: #d63a3a; }
        
        .select2-container { width: 100% !important; }
        .select2-container--default .select2-selection--single {
            height: 40px;
            padding: 5px 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: #fff;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #2c3345;
            line-height: 28px;
            padding-left: 4px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
            right: 8px;
        }
        .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #a0a0a0;
        }
        .select2-dropdown {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .select2-container--default .select2-search--dropdown .select2-search__field {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 8px;
        }
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #0a1551;
        }
        .select2-results__option {
            padding: 10px 12px;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 12px;
            font-size: 13px;
        }
        th, td { 
            border: 1px solid #d9d9d9; 
            padding: 10px 12px; 
            text-align: left; 
        }
        th { 
            background: #f5f5f5;
            font-weight: 500;
            color: #2c3345;
        }
        .remove-btn { 
            color: #d63a3a; 
            cursor: pointer; 
            font-weight: 500;
            font-size: 12px;
        }
        .remove-btn:hover { text-decoration: underline; }
        .max-warning { 
            color: #e67e22; 
            font-size: 12px; 
            margin-top: 6px; 
        }
        .empty-message {
            color: #8a94a6;
            font-style: italic;
            padding: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="status">Loading...</div>
    
    <div class="field">
        <label for="crewSelect">Add crew member (max 4)</label>
        <select id="crewSelect" style="width: 100%">
            <option value="">-- Search crew member --</option>
        </select>
        <div id="maxWarning" class="max-warning" style="display: none;">Maximum 4 members reached</div>
    </div>
    
    <table id="crewTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="crewTableBody">
            <tr><td colspan="4" class="empty-message">No crew member selected</td></tr>
        </tbody>
    </table>

    <script>
        const PROXY_URL = 'https://budibase-proxy.imran-hamdani.workers.dev';
        const BASE_HEIGHT = 180;
        const ROW_HEIGHT = 45;
        const DROPDOWN_EXTRA = 200;
        
        let crewList = [];
        let selectedCrew = [];
        let dataLoaded = false;
        const MAX_CREW = 4;

        function calculateHeight() {
            return BASE_HEIGHT + (selectedCrew.length * ROW_HEIGHT);
        }

        function getValues() {
            const crewData = {};
            selectedCrew.forEach((crew, index) => {
                const num = index + 1;
                crewData[`Crew ${num} ID`] = crew.crew_id;
                crewData[`Crew ${num} First Name`] = crew.first_name;
                crewData[`Crew ${num} Last Name`] = crew.last_name;
            });
            return crewData;
        }

        function sendCurrentData() {
            const values = getValues();
            const isValid = selectedCrew.length > 0;
            JFCustomWidget.sendData({
                valid: isValid,
                value: JSON.stringify(values)
            });
        }

        async function loadData() {
            if (dataLoaded) return;
            dataLoaded = true;
            
            try {
                const response = await fetch(`${PROXY_URL}?table=crew`);
                const result = await response.json();
                crewList = result.data || [];
                
                crewList.forEach(c => {
                    const label = `${c.crew_id} - ${c.first_name} ${c.last_name}`;
                    $('#crewSelect').append(new Option(label, c.crew_id, false, false));
                });
                
                $('#crewSelect').select2({
                    placeholder: '-- Search crew member --',
                    allowClear: true
                });

                // Resize iframe on dropdown open/close
                $('#crewSelect').on('select2:open', function() {
                    JFCustomWidget.requestFrameResize({ height: calculateHeight() + DROPDOWN_EXTRA });
                });
                $('#crewSelect').on('select2:close', function() {
                    JFCustomWidget.requestFrameResize({ height: calculateHeight() });
                });
                
                document.getElementById('status').textContent = `${crewList.length} crew members available`;
                JFCustomWidget.requestFrameResize({ height: calculateHeight() });
                sendCurrentData();
            } catch (error) {
                dataLoaded = false;
                document.getElementById('status').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        $('#crewSelect').on('change', function() {
            const crewId = this.value;
            if (!crewId) return;
            
            if (selectedCrew.length >= MAX_CREW) {
                document.getElementById('maxWarning').style.display = 'block';
                $(this).val('').trigger('change');
                return;
            }
            
            if (selectedCrew.find(c => c.crew_id === crewId)) {
                $(this).val('').trigger('change');
                return;
            }
            
            const crew = crewList.find(c => c.crew_id === crewId);
            if (crew) {
                selectedCrew.push(crew);
                updateTable();
                sendCurrentData();
            }
            
            $(this).val('').trigger('change');
        });

        function updateTable() {
            const tbody = document.getElementById('crewTableBody');
            tbody.innerHTML = '';
            
            if (selectedCrew.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-message">No crew member selected</td></tr>';
            } else {
                selectedCrew.forEach((crew, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${crew.crew_id}</td>
                        <td>${crew.first_name}</td>
                        <td>${crew.last_name}</td>
                        <td><span class="remove-btn" onclick="removeCrew(${index})">âœ• Remove</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('maxWarning').style.display = 
                selectedCrew.length >= MAX_CREW ? 'block' : 'none';
            
            JFCustomWidget.requestFrameResize({ height: calculateHeight() });
        }

        function removeCrew(index) {
            selectedCrew.splice(index, 1);
            updateTable();
            sendCurrentData();
        }

        JFCustomWidget.subscribe("ready", loadData);
        JFCustomWidget.subscribe("submit", function() {
            const values = getValues();
            JFCustomWidget.sendSubmit({
                valid: selectedCrew.length > 0,
                value: JSON.stringify(values)
            });
        });

        setTimeout(() => { if (!dataLoaded) loadData(); }, 500);
    </script>
</body>
</html>
