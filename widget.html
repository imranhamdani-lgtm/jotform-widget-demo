<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 10px; margin: 0; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        #status { color: #666; font-size: 12px; }
        .error { color: red; }
    </style>
</head>
<body>
    <div id="status">Chargement des projets...</div>
    
    <label for="projectSelect">Project #</label>
    <select id="projectSelect">
        <option value="">-- Sélectionner un projet --</option>
    </select>
    
    <label for="clientName">Client (auto-filled)</label>
    <input type="text" id="clientName" readonly>
    
    <label for="vehicleSelect">Vehicle</label>
    <select id="vehicleSelect">
        <option value="">-- Sélectionner un véhicule --</option>
    </select>

    <script>
        // URL du proxy Cloudflare Worker (remplace par ton URL)
        const PROXY_URL = 'https://budibase-proxy.imran-hamdani.workers.dev';
        
        const TABLES = {
            projects: 'ta_8ed4650a5c5041538e4510a3b6350ca0',
            vehicles: 'ta_9b93207c19104a8f9acf951fae225b20'
        };

        let projects = [];
        const projectSelect = document.getElementById('projectSelect');
        const vehicleSelect = document.getElementById('vehicleSelect');
        const clientInput = document.getElementById('clientName');
        const status = document.getElementById('status');

        async function fetchTable(tableId) {
            const response = await fetch(`${PROXY_URL}?table=${tableId}`);
            if (!response.ok) throw new Error('Proxy error: ' + response.status);
            const result = await response.json();
            return result.data;
        }

        async function loadData() {
            try {
                // Charger projets
                projects = await fetchTable(TABLES.projects);
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.project_number;
                    option.textContent = `${p.project_number} - ${p.client}`;
                    projectSelect.appendChild(option);
                });

                // Charger véhicules
                const vehicles = await fetchTable(TABLES.vehicles);
                vehicles.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.vehicle_number;
                    option.textContent = v.vehicle_number;
                    vehicleSelect.appendChild(option);
                });

                status.textContent = `${projects.length} projets, ${vehicles.length} véhicules`;
            } catch (error) {
                status.innerHTML = `<span class="error">Erreur: ${error.message}</span>`;
                console.error(error);
            }
        }

        // Auto-remplissage du client
        projectSelect.addEventListener('change', function() {
            const project = projects.find(p => p.project_number === this.value);
            clientInput.value = project ? project.client : '';
        });

        // Intégration JotForm
        JFCustomWidget.subscribe("ready", loadData);
        JFCustomWidget.subscribe("submit", function() {
            JFCustomWidget.sendSubmit({
                valid: projectSelect.value !== '',
                value: JSON.stringify({
                    project_number: projectSelect.value,
                    client: clientInput.value,
                    vehicle: vehicleSelect.value
                })
            });
        });

        // Fallback: charger les données si ready ne se déclenche pas
        setTimeout(function() {
            if (status.textContent === 'Chargement des projets...') {
                loadData();
            }
        }, 500);
    </script>
</body>
</html>
